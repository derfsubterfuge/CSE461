package edu.uw.cs.cse461.sp12.OS;

// Android version

import java.io.File;

import android.database.sqlite.SQLiteDatabase;
import android.database.sqlite.SQLiteException;
import android.database.sqlite.SQLiteStatement;
import android.util.Log;
import edu.uw.cs.cse461.sp12.OS.DDNSService.FullName;
import edu.uw.cs.cse461.sp12.OS.NameManagerBase.NameException;
import edu.uw.cs.cse461.sp12.OS.NameManagerBase.NameRecord;
import edu.uw.cs.cse461.sp12.OS.NameManagerBase.RecordSet;

public class NameManager extends NameManagerBase {

	private final String TAG="NameManager_DB";

	public static String[] fields[] = { {"name", "TEXT"},
		{"type", "TEXT"},
		{"value", "TEXT"},
		{"authoritative", "INTEGER"},
		{"timestamp", "INTEGER"}  // unix time record was last written
	};
	public static final String TABLENAME = "names";

	private SQLiteDatabase mDB;

	public NameManager() throws NameException {	
	}
	
	private class DBOpenHelper extends SQLiteOpenHelper {
		
	}

	@Override
	protected void openOrCreateDatabase(String dbName) throws Exception {
		File dbFile = new File(dbName);
		if ( !dbFile.exists() ) {
			// need to initialize DB
			mDB = new SQLiteConnection(dbFile);
			mDB.open(true);

			// create the names table
			StringBuilder sb = new StringBuilder().append("CREATE TABLE IF NOT EXISTS ").append(TABLENAME).append(" (")
					.append(fields[0][0]).append(" ").append(fields[0][1]);
			for ( int i=1; i<fields.length; i++) {
				sb.append(", ").append(fields[i][0]).append(" ").append(fields[i][1]);
			}
			sb.append(")");
			query(sb.toString());

		} else {
			mDB = new SQLiteConnection(dbFile);
			mDB.open(true);
		}
	}

	@Override
	public void close() {
		if ( mDB != null ) mDB.dispose();
		mDB = null;
	}

	@Override
	public RecordSet query(String query) throws NameException {
		RecordSet result = new RecordSet(); 
		SQLiteStatement st = null;

		if ( mDB == null ) throw new NameException("NameManager_DB.query(" + query + "): db is not open");

		try {
			st = mDB.prepare(query);

			while(st.step()) {
				NameRecord row = new NameRecord();
				// sqlite null seems to be stored as "null"
				String recordname = st.columnString(0); 
				if ( recordname.equals("null") ) recordname = null;
				row.name = new FullName(recordname);

				row.type = st.columnString(1);
				row.type = row.type.equals("null")?null:row.type;

				row.value = st.columnString(2);
				row.value = row.value.equals("null")?null:row.value;

				row.authoritative = st.columnInt(3) == 1;
				row.timestamp = st.columnInt(4);
				result.add(row);
			}
		} catch (SQLiteException e) {
			String msg = "SQLiteException on query(" + query + "): " + e.getMessage();
			Log.e(TAG, msg);
			throw new NameException(msg);
		} finally {
			if ( st != null ) st.dispose();
		}
		return result;
	}
}
