package edu.uw.cs.cse461.sp12.OS;

import java.io.File;

import android.database.Cursor;
import android.database.sqlite.SQLiteDatabase;
import android.database.sqlite.SQLiteException;
import edu.uw.cs.cse461.sp12.OS.DDNSService.FullName;
import edu.uw.cs.cse461.sp12.OS.NameManager.NameException;
import edu.uw.cs.cse461.sp12.OS.NameManager.NameRecord;
import edu.uw.cs.cse461.sp12.OS.NameManager.RecordSet;
import edu.uw.cs.cse461.sp12.util.Log;

public class NameManager_DB {
	private final String TAG="NameManager_DB";

	public static String[] fields[] = { {"name", "TEXT"},
										{"type", "TEXT"},
										{"value", "TEXT"},
										{"authoritative", "INTEGER"},
										{"timestamp", "INTEGER"}  // unix time record was last written
     								  };
	public static final String TABLENAME = "names";
	
	private SQLiteDatabase mDB;
	
	void openOrCreateDatabase(String dbName) throws Exception {
		File dbFile = new File(dbName);
		if ( !dbFile.exists() ) {
			// need to initialize DB
			mDB = SQLiteDatabase.open(dbFile);

			// create the names table
			StringBuilder sb = new StringBuilder().append("CREATE TABLE IF NOT EXISTS ").append(TABLENAME).append(" (")
													.append(fields[0][0]).append(" ").append(fields[0][1]);
			for ( int i=1; i<fields.length; i++) {
				sb.append(", ").append(fields[i][0]).append(" ").append(fields[i][1]);
			}
			sb.append(")");
			mDB.execSQL(sb.toString());

		} else {
			mDB = SQLiteDatabase.openDatabase(dbFile);
		}
	}
	
	public void close() {
		if ( mDB != null ) mDB.close();
		mDB = null;
	}
	
	public RecordSet query(String query) throws NameException {
		RecordSet result = new RecordSet(); 
		Cursor st = null;
		
		if ( mDB == null ) throw new NameException("NameManager_DB.query(" + query + "): db is not open");
		
		try {
			
			for ( st = mDB.rawQuery(query, null); st.getPosition() < 
			
			while(st.step()) {
				NameRecord row = new NameRecord();
				// sqlite null seems to be stored as "null"
				String recordname;
				if ( st.isNull(0)) recordname = null;
				else recordname = st.getString(0); 
				row.name = new FullName(recordname);

				if ( st.isNull(1)) row.type = null;
				else row.type = st.getString(1);
				
				row.value = st.getString(2);
				row.value = row.value.equals("null")?null:row.value;

				row.authoritative = st.getInt(3) == 1;
				row.timestamp = st.getInt(4);
				result.add(row);
			}
		} catch (SQLiteException e) {
			String msg = "SQLiteException on query(" + query + "): " + e.getMessage();
			Log.e(TAG, msg);
			throw new NameException(msg);
		} finally {
			if ( st != null ) st.dispose();
		}
		return result;
	}
	
	

}
