package edu.uw.cs.cse461.sp12.OS;

// Android version

import android.database.Cursor;
import android.database.sqlite.SQLiteDatabase;
import android.database.sqlite.SQLiteException;
import android.database.sqlite.SQLiteOpenHelper;
import android.util.Log;

public class NameManager_DB {
	private final String TAG="NameManager_DB";

	public static String[] fields[] = { {"name", "TEXT"},
										{"type", "TEXT"},
										{"value", "TEXT"},
										{"authoritative", "INTEGER"},
										{"timestamp", "INTEGER"}  // unix time record was last written
     								  };
	public static final String TABLENAME = "names";
	
	private NameDBOpener mDBOpenHelper;
	private SQLiteDatabase mDB;
	
	private static class NameDBOpener extends SQLiteOpenHelper {
		NameDBOpener(String dbName) {
			super(ContextManager.getContext(), dbName, null, 1);
		}
		
		public void onCreate(SQLiteDatabase db) {
			// create the names table
			StringBuilder sb = new StringBuilder().append("CREATE TABLE IF NOT EXISTS ").append(TABLENAME).append(" (")
													.append(fields[0][0]).append(" ").append(fields[0][1]);
			for ( int i=1; i<fields.length; i++) {
				sb.append(", ").append(fields[i][0]).append(" ").append(fields[i][1]);
			}
			sb.append(")");
			db.execSQL(sb.toString());
		}
		
		public void onUpgrade(SQLiteDatabase db, int oldVersion, int newVersion) {
		}
	}
	
	void openOrCreateDatabase(String dbName) throws Exception {
		mDBOpenHelper = new NameDBOpener(dbName);
		mDB = mDBOpenHelper.getWritableDatabase();
	}
	
	public void close() {
		if ( mDB != null ) mDB.close();
		mDB = null;
	}
	
	public RecordSet query(String query) throws NameException {
		RecordSet result = new RecordSet(); 
		Cursor st = null;
		
		if ( mDB == null ) throw new NameException("NameManager_DB.query(" + query + "): db is not open");
		
		try {
			
			st = mDB.rawQuery(query, null);
			while(st.moveToNext()) {
				NameRecord row = new NameRecord();
				// sqlite null seems to be stored as "null"
				String recordname;
				if ( st.isNull(0)) recordname = null;
				else recordname = st.getString(0); 
				row.name = new FullName(recordname);

				if ( st.isNull(1)) row.type = null;
				else row.type = st.getString(1);

				if ( st.isNull(2)) row.value = null;
				else row.value = st.getString(2);

				if ( st.isNull(3)) row.authoritative = false;
				else row.authoritative = st.getInt(3) != 0;
				
				if ( st.isNull(4)) row.timestamp = 0;
				else row.timestamp = st.getInt(4);
				
				result.add(row);
			}
		} catch (SQLiteException e) {
			String msg = "SQLiteException on query(" + query + "): " + e.getMessage();
			Log.e(TAG, msg);
			throw new NameException(msg);
		} finally {
			if ( st != null ) st.close();
		}
		return result;
	}
	
	

}
