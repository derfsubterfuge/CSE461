package edu.uw.cs.cse461.HTTP;

import java.io.IOException;
import java.util.Properties;

import edu.uw.cs.cse461.NetBase.NetBase;
import edu.uw.cs.cse461.NetBase.NetLoadableInterface.NetLoadableService;
import edu.uw.cs.cse461.NetBase.DDNS.DDNSFullName;
import edu.uw.cs.cse461.NetBase.DDNS.DDNSResolverService;
import edu.uw.cs.cse461.util.Log;

/**
 * Implements a simple HTTP server.  The URI's are of form http://host:ip/<servicename>/....
 * It's up to the service to implement the HTTPProvider interface.
 * <p>
 * There's a small, technical issue that affects the implementation.  The service
 * loading code, in the OS, needs a constructor that takes no arguments.  We want to
 * extend NanoHTTPD, though, and its constructor requires a port number.  Thus, the 
 * public class contains an inner class that extends NanoHTTPD.
 * @author zahorjan
 *
 */
public class HTTPDService implements NetLoadableService {
	private static final String TAG="HTTPDService";

	private NanoHTTPDService mNanoService;

	public interface HTTPProvider {
		// uriArray[0] is empty
		// uriArray[1] is service name (e.g., "ddns")
		// higher elements are some uri path specific to the service
		public String httpServe(String[] uriArray) throws Exception;
	}

	@Override
	public String loadablename() { 
		return "httpd"; 
	}
	
	@Override
	public void shutdown() { 
		if ( mNanoService != null ) mNanoService.stop();
		mNanoService = null;
		try {
			DDNSResolverService resolver = (DDNSResolverService)NetBase.theNetBase().getService("ddnsresolver");
			if ( resolver == null ) Log.w(TAG, "No local resolver.  Can't unregister name www");
			else resolver.unregister(new DDNSFullName(NetBase.theNetBase().hostname() + ".www") );  
		} catch (Exception e) {
			Log.w(TAG, "ADVISORY: Caught exception while unregistering with parent:\n" + e.getMessage());
		}
	}

	private class NanoHTTPDService extends NanoHTTPD {
		/**
		 * Specify port 0 if you don't care what port the name server uses.
		 * @param port
		 * @throws IOException
		 */
		public NanoHTTPDService(int port) throws IOException {
			super(port,null); // nano won't like the null webroot, if it ever uses it, preventing inadvertently allowing access to local files via nano 
		}

		@Override
		public Response serve( String uri, String method, Properties header, Properties parms, Properties files ) {
			if ( uri == null ) return new Response( HTTP_NOTFOUND, MIME_HTML, HTTP_NOTFOUND);
			try {
				Log.i(TAG,  "method = '" + method + "'  uri=" + uri);

				String[] uriVec = uri.split("/");
				if ( uriVec.length < 1 ) return new Response( HTTP_NOTFOUND, MIME_HTML, HTTP_NOTFOUND);

				try {
					HTTPProvider provider = (HTTPProvider)NetBase.theNetBase().getService(uriVec[1]);
					if ( provider == null ) provider = (HTTPProvider)NetBase.theNetBase().getApp(uriVec[1]);
					if ( provider == null ) return new Response( HTTP_NOTFOUND, MIME_HTML, HTTP_NOTFOUND);
					String response = provider.httpServe(uriVec);
					String mimeType = MIME_PLAINTEXT;
					if ( response.startsWith("<html>")) mimeType = MIME_HTML;
					return new Response( HTTP_OK, mimeType, response );
				} catch (Exception e) {
					Log.e(TAG, "server response exception:");
					e.printStackTrace();
					return new Response( HTTP_NOTFOUND, MIME_PLAINTEXT, e.getMessage());
				}

			} catch (Exception e) {
				Log.e(TAG, "server: " + e.getMessage());
				e.printStackTrace();
				return new Response( HTTP_INTERNALERROR, MIME_HTML, HTTP_INTERNALERROR + "<p><pre>" + e.getMessage() + "</pre>");
			}
		}
	}
	
	int httpdPort() {
		if ( mNanoService != null ) return mNanoService.localPort();
		return -1;
	}

	public HTTPDService() throws IOException {
		NetBase theOS = NetBase.theNetBase();
		int port = theOS.config().getInt("httpd.port", 0, 0, TAG);
		this.mNanoService = new NanoHTTPDService(port);
		port = httpdPort();

		// create a name entry for me, but dont' fail to start just because we can't register
		try {
			String wwwName = theOS.config().getProperty("httpd.name");
			if ( wwwName != null && !wwwName.isEmpty()) {
				DDNSResolverService resolver = (DDNSResolverService)theOS.getService("ddnsresolver");
				if ( resolver == null ) Log.w(TAG, "No local resolver.  Can't register name " + wwwName);
//				else resolver.register(new DDNSFullName(OS.hostname() + ".www"), port );
				else resolver.register(new DDNSFullName(wwwName), port );
			} else {
				Log.w(TAG,  "No httpd.name entry in config file.  Won't try to register name server address.");
			}
		} catch (Exception e) {
			Log.w(TAG , "Couldn't register name: " + e.getMessage());
		}
		Log.w(TAG, "Service started on port " + mNanoService.localPort());
	}
}
