package edu.uw.cs.cse461.sp12.OS;

// Android version

import android.database.Cursor;
import android.database.sqlite.SQLiteDatabase;
import android.database.sqlite.SQLiteException;
import android.database.sqlite.SQLiteOpenHelper;
import android.util.Log;
import edu.uw.cs.cse461.sp12.OS.DDNSService.FullName;

public class NameManager extends NameManagerBase {

	private final String TAG="NameManager_DB";

	public static String[] fields[] = { {"name", "TEXT"},
		{"type", "TEXT"},
		{"value", "TEXT"},
		{"authoritative", "INTEGER"},
		{"timestamp", "INTEGER"}  // unix time record was last written
	};
	
	public static final String TABLENAME = "names";
	public static final int DBVERSION = 1;

	private SQLiteDatabase mDB;

	public NameManager() throws NameException {	
	}
	
	private class DBOpenHelper extends SQLiteOpenHelper {
		
		public DBOpenHelper(String dbName) {
			super(ContextManager.getContext(), dbName, null, DBVERSION);
		}
		
		@Override
		public void onCreate(SQLiteDatabase db) {
			// create the names table
			StringBuilder sb = new StringBuilder().append("CREATE TABLE IF NOT EXISTS ").append(TABLENAME).append(" (")
					.append(fields[0][0]).append(" ").append(fields[0][1]);
			for ( int i=1; i<fields.length; i++) {
				sb.append(", ").append(fields[i][0]).append(" ").append(fields[i][1]);
			}
			sb.append(")");
			db.execSQL(sb.toString());
		}
		
		@Override
		public void onUpgrade(SQLiteDatabase db, int oldVersion, int newVersion) {
		}
	}

	@Override
	protected void openOrCreateDatabase(String dbName) throws Exception {
		mDB = new DBOpenHelper(dbName).getWritableDatabase();
	}

	@Override
	public void close() {
		if ( mDB != null ) mDB.close();
		mDB = null;
	}

	@Override
	public RecordSet query(String query) throws NameException {
		RecordSet result = new RecordSet(); 
		Cursor st = null;

		if ( mDB == null ) throw new NameException("NameManager_DB.query(" + query + "): db is not open");

		try {
			st = mDB.rawQuery(query, null);

			while(st.moveToNext()) {
				NameRecord row = new NameRecord();
				
				// sqlite null seems to be stored as "null"
				String recordname;
				if ( st.isNull(0)) recordname = null;
				recordname = st.getString(0); 
				row.name = new FullName(recordname);

				if ( st.isNull(1) ) row.type = null;
				row.type = st.getString(1);

				if ( st.isNull(2) ) row.value = null;
				else row.value = st.getString(2);

				row.authoritative = st.columnInt(3) == 1;
				row.timestamp = st.columnInt(4);
				result.add(row);
			}
		} catch (SQLiteException e) {
			String msg = "SQLiteException on query(" + query + "): " + e.getMessage();
			Log.e(TAG, msg);
			throw new NameException(msg);
		} finally {
			if ( st != null ) st.dispose();
		}
		return result;
	}
}
