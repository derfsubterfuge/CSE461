package edu.uw.cs.cse461.ConsoleApps;

import java.io.BufferedReader;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.OutputStream;
import java.net.DatagramPacket;
import java.net.DatagramSocket;
import java.net.InetSocketAddress;
import java.net.Socket;
import java.net.SocketTimeoutException;

import edu.uw.cs.cse461.Net.Base.NetBase;
import edu.uw.cs.cse461.Net.Base.NetLoadable.NetLoadableConsoleApp;
import edu.uw.cs.cse461.util.ConfigManager;
import edu.uw.cs.cse461.util.ElapsedTime;

/**
 * Raw sockets version of ping client.
 * @author zahorjan
 *
 */
public class PingRaw extends NetLoadableConsoleApp {
	private static final String TAG="PingRaw";
	
	// ConsoleApp's must have a constructor taking no arguments
	public PingRaw() {
		super("pingraw", true);
	}
	
	@Override
	public void run() {
		try {
			// Eclipse doesn't support System.console()
			BufferedReader console = new BufferedReader(new InputStreamReader(System.in));
			ConfigManager config = NetBase.theNetBase().config();

			try {

				ElapsedTime.clear();

				String targetIP = config.getProperty("echoraw.server");
				if ( targetIP == null ) {
					System.out.println("No echoraw.server entry in config file.");
					System.out.print("Enter a host ip, or empty line to exit: ");
					targetIP = console.readLine();
					if ( targetIP == null || targetIP.trim().isEmpty() ) return;
				}

				int targetUDPPort = config.getAsInt("echoraw.udpport", 0, TAG);
				if ( targetUDPPort == 0 ) {
					System.out.print("Enter the server's UDP port, or empty line to skip: ");
					String targetUDPPortStr = console.readLine();
					if ( targetUDPPortStr == null || targetUDPPortStr.trim().isEmpty() ) targetUDPPort = 0;
					else targetUDPPort = Integer.parseInt(targetUDPPortStr);
				}

				int targetTCPPort = config.getAsInt("echoraw.tcpport", 0, TAG);
				if ( targetTCPPort == 0 ) {
					System.out.print("Enter the server's TCP port, or empty line to skip: ");
					String targetTCPPortStr = console.readLine();
					if ( targetTCPPortStr == null || targetTCPPortStr.trim().isEmpty() ) targetTCPPort = 0;
					else targetTCPPort = Integer.parseInt(targetTCPPortStr);
				}

				int nTrials = config.getAsInt("ping.ntrials", 5, TAG);

				String msg = "ping";

				if ( targetUDPPort != 0  ) {
					DatagramSocket socket = new DatagramSocket();
					socket.setSoTimeout(500); // wait at most 500 msec.
					for ( int trial=0; trial<nTrials; trial++ ) {
						ElapsedTime.start("PingRaw_UDPTotalDelay");
						byte[] buf = msg.getBytes();
						DatagramPacket packet = new DatagramPacket(buf, buf.length, new InetSocketAddress(targetIP, targetUDPPort));
						socket.send(packet);

						byte[] receiveBuf = new byte[buf.length];
						DatagramPacket receivePacket = new DatagramPacket(receiveBuf, receiveBuf.length);
						try { 
							socket.receive(receivePacket);
							ElapsedTime.stop("PingRaw_UDPTotalDelay");
						} catch (SocketTimeoutException e) {
							System.out.println("UDP socket timeout");
							ElapsedTime.abort("PingRaw_UDPTotalDelay");
						}
					}
				}


				if ( targetTCPPort != 0 ) {
					ElapsedTime.start("PingRaw_TCPConnect");
					Socket tcpSocket = new Socket(targetIP, targetTCPPort);
					ElapsedTime.stop("PingRaw_TCPConnect");
					tcpSocket.setSoTimeout(500);
					InputStream is = tcpSocket.getInputStream();
					OutputStream os = tcpSocket.getOutputStream();
					byte[] msgBytes = msg.getBytes();
					byte[] buf = new byte[msgBytes.length];
					for ( int trial=0; trial<nTrials; trial++) {
						ElapsedTime.start("PingRaw_TCPPostConnectionDelay");
						os.write(msgBytes, 0, msgBytes.length);
						try {
							int len = 0;
							while ( len < msgBytes.length) {
								len += is.read(buf, 0, buf.length);
							}
							ElapsedTime.stop("PingRaw_TCPPostConnectionDelay");
						} catch (Exception e) {
							System.out.println("TCP read failed: " + e.getMessage());
							ElapsedTime.abort("PingRaw_TCPPostConnectionDelay");
						}
					}
					tcpSocket.close();
				}

				System.out.println( ElapsedTime.statString());

			} catch (Exception e) {
				System.out.println("Exception: " + e.getMessage());
			} 
		} catch (Exception e) {
			System.out.println("PingRaw.run() caught exception: " +e.getMessage());
		}
	}
	
	@Override
	public void shutdown() {
	}
	
}
